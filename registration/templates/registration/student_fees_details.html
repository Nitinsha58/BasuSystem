{% extends 'base.html' %}
{% load static %}

{% block dashboard %}
<div class="container-sm p-4 ">
    <div class="bg-success-subtle mx-auto p-1 d-flex rounded" style="width: fit-content;">
        <a href="{% url 'student_update' student.stu_id %}" class="text-decoration-none text-dark p-1 px-2 rounded mx-2 my-1">Student</a>
        <a href="{% url 'student_parent_details' student.stu_id %}" class="text-decoration-none text-dark p-1 px-2 rounded mx-2 my-1">Parent Details</a>
        <a href="{% url 'student_fees_details' student.stu_id %}" class="text-decoration-none text-dark bg-light p-1 px-2 rounded mx-2 my-1">Fee Details</a>
        <a href="{% url 'student_transport_details' student.stu_id %}" class="text-decoration-none text-dark p-1 px-2 rounded mx-2 my-1">Transport Details</a>
        <a href="{% url 'student_reg_doc' student.stu_id %}" class="text-decoration-none text-dark p-1 px-2 rounded mx-2 my-1">Get Document</a>
    </div>

    <div class="my-4 mt-2">
        <h2 class="fw-normal text-dark">{{student.user.first_name}}'s Fee Details </h2>
    </div>

    <form class="g-3 bg-light rounded p-2 pb-3" method="post">
      {% csrf_token %}
      <div class="row justify-content-evenly mt-3">
        <div class="col-md-10">
          <p class="form-label fs-4 fw-normal text-end">Total: <span id="total_fees">{{fees_details.total_fees}}</span></p>
        </div>
      </div>
      <input type="text" hidden value="{{fees_details.total_fees}}" class="form-control" name="total_fees" id="total_fees_input">
      <div class="row justify-content-evenly mt-3">
        <div class="col-md-4">
          <label for="book_fees" class="form-label">Book Fees</label>
          <input type="text" value="{{fees_details.book_fees}}" class="form-control" name="book_fees" id="book_fees">
        </div>
        <div class="col-md-4">
          <label for="uniform_fees" class="form-label">Uniform Fees</label>
          <input type="text" value="{{fees_details.uniform_fees}}" class="form-control" name="uniform_fees" id="uniform_fees">
        </div>
      </div>
      
      <div class="row justify-content-evenly mt-3">
        <div class="col-md-4">
          <label for="cab_fees" class="form-label">Cab Fees</label>
          <input type="text" minlength="10" value="{{fees_details.cab_fees}}" maxlength="10" class="form-control" name="cab_fees" id="cab_fees">
        </div>

        <div class="col-md-4">
          <label for="tuition_fees" class="form-label">Tuition Fees</label>
          <input type="text" minlength="10" maxlength="10" value="{{fees_details.tuition_fees}}" class="form-control" name="tuition_fees" id="tuition_fees" required>
        </div>
      </div>
      <div class="row mt-3">
          <div class="col-md-1"></div>

          <div class="col-md-3 ms-4">
            <label for="tuition_fees" class="form-label">No. Of Installments</label>
            <div class="d-flex p-1 px-2 rounded m-0" style="width: fit-content; background-color: white;">
              {% if not fees_details %}
              <button id="decrement-btn" class="btn bg-danger-subtle m-0 " type="button">-</button>
              {% endif %}
                <input id="count-input" name="num_installments" readonly class="m-0 border-0 rounded d-flex justify-content-center align-items-center" style="width: 40px; height: 40px; padding: 7px; text-align: center;"
                 {% if fees_details %} value="{{fees_details.installments.all.count}}" {% else %} value="1" {% endif %}>
                {% if not fees_details %}
                <button id="increment-btn" class="btn bg-success-subtle m-0 " type="button">+</button>
                {% endif %}
            </div>
          </div>
      </div>

      <div class="installments rounded p-2 my-2" style="background-color: white;">

        <div class="row installment m-0 justify-content-evenly">
          {% for installment in fees_details.installments.all %}
          <div class="col-10 col-md-8 rounded p-2 d-flex flex-column align-items-end">
            <div class="d-flex justify-content-between w-100">
              <p class="m-0 h4 fw-normal">{{forloop.counter}}. Installment </p>
              <div class="">
                <input type="number" name="installment_amount_{{forloop.counter}}" class="rounded p-1 px-2" value="{{installment.amount}}" style="border: 2px solid rgba(184, 184, 184, 0.794);" id="installment-amt-1">
                <input type="date" name="installment_due_date_{{forloop.counter}}" value="{{installment.due_date|date:'Y-m-d'}}" class="mt-1 rounded p-1 px-2" style="border: 2px solid rgba(184, 184, 184, 0.794);" id="installment-date-1">
              </div>
            </div>
            <div class="form-check form-switch mt-2">
              <label class="form-check-label" for="flexSwitchCheckChecked">Paid</label>
              <input class="form-check-input w-4 h-4" type="checkbox" name="paid_{{forloop.counter}}" {% if installment.paid %} checked {% endif %} role="switch" id="flexSwitchCheckChecked">
            </div>
          </div>
          {% endfor %}

        </div>
      </div>

      <div class="d-flex justify-content-center mt-3">
        <div class="">
          <button class="btn btn-warning" type="submit">Save Fee Details</button>
        </div>
      </div>
    </form>
</div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const decrementBtn = document.getElementById("decrement-btn");
    const incrementBtn = document.getElementById("increment-btn");
    const countInput = document.getElementById("count-input");
    const totalFeesElement = document.getElementById("total_fees");
    const totalFeesInput = document.getElementById("total_fees_input");
    const installmentContainer = document.querySelector(".installments");
    const feeInputs = document.querySelectorAll("#book_fees, #uniform_fees, #cab_fees, #tuition_fees");
    today = new Date().toISOString().split('T')[0];


    function calculateTotalFees() {
        let totalFees = 0;
        feeInputs.forEach(input => {
            totalFees += parseInt(input.value || 0, 10);
        });
        totalFeesElement.textContent = totalFees.toLocaleString();
        totalFeesInput.value = totalFees;
        
        {% if not fees_details %}
        updateInstallments(totalFees);
        {% endif %}
    }

    function updateInstallments(totalFees) {
        let numInstallments = parseInt(countInput.value, 10);
        let baseInstallment = Math.floor(totalFees / numInstallments);
        let remainder = totalFees % numInstallments;
        
        installmentContainer.innerHTML = ""; // Clear previous installments

        for (let i = 0; i < numInstallments; i++) {
            let installmentAmount = baseInstallment + (i === 0 ? remainder : 0); // Adjust remainder in the first installment

            let installmentDiv = document.createElement("div");
            installmentDiv.classList.add("row", "installment","m-0", "justify-content-evenly");

            installmentDiv.innerHTML = `
              <div class="col-10 col-md-8  rounded p-2 d-flex flex-column align-items-end">
                <div class="d-flex justify-content-between w-100">
                  <p class="m-0 h4 fw-normal text-dark">${i + 1}. Installment </p>
                  <div class="">
                    <input type="number" name="installment_amount_${i+1}" value=${installmentAmount} class="rounded p-1 px-2" style="border: 2px solid rgba(184, 184, 184, 0.794);" id="installment-amt-${i + 1}" required>
                    <input type="date" name="installment_due_date_${i+1}" value=${today} class="mt-1 rounded p-1 px-2" style="border: 2px solid rgba(184, 184, 184, 0.794);" id="installment-date-${i + 1}" required>
                  </div>
                </div>

                <div class="form-check form-switch mt-2">
                  <label class="form-check-label" for="paid_${i+1}">Paid</label>
                  <input class="form-check-input w-4 h-4" type="checkbox" role="switch" name="paid_${i+1}" id="paid_${i+1}">
                </div>
              </div>
            `;

            installmentContainer.appendChild(installmentDiv);
        }
    }

    feeInputs.forEach(input => {
        input.addEventListener("input", function () {
            this.value = this.value.replace(/\D/g, "").slice(0, 10); // Allow only numbers
            calculateTotalFees();
        });
    });

    decrementBtn.addEventListener("click", function () {
        let count = parseInt(countInput.value, 10);
        if (count > 1) {
            countInput.value = count - 1;
            calculateTotalFees();
        }
    });

    incrementBtn.addEventListener("click", function () {
        let count = parseInt(countInput.value, 10);
        if (count < 12) {
            countInput.value = count + 1;
            calculateTotalFees();
        }
    });

    calculateTotalFees(); // Initialize on page load
  });
</script>


{% endblock dashboard %}