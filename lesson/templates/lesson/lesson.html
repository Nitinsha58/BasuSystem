{% extends 'base.html' %}
{% load static %}

{% block style %}
<style>
    html {
      scroll-behavior: auto !important;
    }

    .draggable {
        padding: 1rem;
        /* border: 1px solid black; */
        cursor: move;
        user-select: none;
    }

    .draggable.dragging {
        opacity: .8;
        border: 2px dashed #3863f4;
    }
</style>
{% endblock style %}

{% block dashboard %}
<div class="content-container m-2 m container mx-auto">
    <h2 class="heading m-2">Lessons Ch-{{sq.chapter_no}}. {{sq.chapter_name}} - {{sq.batch.subject.name}} {{sq.batch.section.name}}</h2>

    {% if lessons %}
    <div id="updateModal" class="my-4">
        <form action="" method="post" class="bg-white rounded-lg p-2 py-md-4 p-md-4 rounded">
            {% csrf_token %}
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex justify-content-end mt-4">
                    <a href="{% url 'lesson_plan' %}{{class_id}}/{{batch_id}}" id="cancelButton" class="px-4 py-2 btn btn-primary me-2">Go Back</a>
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <a href="{% url 'lesson_plan' %}{{class_id}}/{{batch_id}}" class="px-4 py-2 btn btn-primary me-2">Cancel</a>
                    <button id="confirmButton" type="submit" class="px-4 py-2 btn  btn-warning ">Save</button>
                </div>
            </div>
            <div class="container mt-3">
                <ul class="list-group drag-container">
                    {% for lesson in lessons %}
                    <li draggable="true" class="draggable list-group-item d-flex align-items-md-center">
                        <p  class="m-0 me-3 sequence-no"> {{lesson.sequence}}.</p>
                        <div class="d-flex gap-2 gap-md-4 flex-column flex-md-row w-100">
                            <input class="form-control lesson-topic" type="text" name="lessons[][topic]" value="{{ lesson.topic }}" placeholder="topic..." required>
                            <input class="form-control lesson-homework" type="text" name="lessons[][homework]" value="{{ lesson.homework }}" placeholder="homework...">
                            <input class="form-control lesson-classwork" type="text" name="lessons[][classwork]" value="{{ lesson.classwork }}" placeholder="classwork...">
                            <input type="hidden" class="lesson-data" name="lessons[]" value="{{ lesson.sequence }}:{{ lesson.id }}:{{ lesson.topic }}:{{ lesson.homework }}:{{ lesson.classwork }}" required>
                            
                            <div  class="px-2 py-2 d-flex align-items-center justify-content-center btn btn-outline-danger fw-semibold text-decoration-none" onclick="deleteLesson(event)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path>
                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path>
                                </svg>
                            </div>
                        </div>
                    </li>
                    {% endfor %}

                </ul>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex justify-content-end mt-4">
                    <div id="add-lesson" onclick="addLesson()"  class="px-4 py-2 btn btn-success me-2">Add Lesson</div>
                </div>
            </div>


        </form>
    </div>
    {% else %}
        <div id="updateModal" class="my-4">
        <form action="" method="post" class="bg-white rounded-lg p-2 py-md-4 p-md-4 rounded">
            {% csrf_token %}
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex justify-content-end mt-4">
                    <a href="{% url 'lesson_plan' %}{{class_id}}/{{batch_id}}" id="cancelButton" class="px-4 py-2 btn btn-primary me-2">Go Back</a>
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <a href="{% url 'lesson_plan' %}{{class_id}}/{{batch_id}}" class="px-4 py-2 btn btn-primary me-2">Cancel</a>
                    <button id="confirmButton" type="submit" class="px-4 py-2 btn  btn-warning ">Save</button>
                </div>
            </div>
            <div class="container mt-3">
                <ul class="list-group drag-container">

                </ul>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex justify-content-end mt-4">
                    <div id="add-lesson" onclick="addLesson()"  class="px-4 py-2 btn btn-success me-2">Add Lesson</div>
                </div>
            </div>


        </form>
    </div>
    {% endif %}
</div>


<script>
// DOM Selectors
const lessonModal = document.getElementById('updateModal');
const dragContainers = document.querySelectorAll('.drag-container');

// Utility
function createElementFromHTML(html) {
    const div = document.createElement('div');
    div.innerHTML = html.trim();
    return div.firstChild;
}

function getLessonHTML() {
    return `
        <li draggable="true" class="draggable list-group-item d-flex align-items-md-center">
            <p class="m-0 me-3 sequence-no"></p>
            <div class="d-flex gap-2 gap-md-4 flex-column flex-md-row w-100">
                <input class="form-control lesson-topic" type="text" name="lessons[][topic]" placeholder="topic..." required>
                <input class="form-control lesson-homework" type="text" name="lessons[][homework]" placeholder="homework...">
                <input class="form-control lesson-classwork" type="text" name="lessons[][classwork]" placeholder="classwork...">
                <input type="hidden" class="lesson-data" name="lessons[]" required>
                <div class="px-2 py-2 d-flex align-items-center justify-content-center btn btn-outline-danger fw-semibold text-decoration-none" onclick="deleteLesson(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path>
                    </svg>
                </div>
            </div>
        </li>
    `;
}

// Actions
function addLesson() {
    const newLesson = createElementFromHTML(getLessonHTML());
    lessonModal.querySelector('.drag-container').appendChild(newLesson);
    updateLessonInputs();
    bindLessonInputListeners();
    bindDraggable(newLesson);
}

function deleteLesson(event) {
    const lessonItem = event.target.closest('.draggable');
    if (lessonItem) {
        lessonItem.remove();
        updateLessonInputs();
    }
}

function updateLessonInputs() {
    const items = document.querySelectorAll('.draggable');
    const lessons = [];

    items.forEach((item, index) => {
        item.querySelector('.sequence-no').textContent = `${index + 1}.`;

        const topic = item.querySelector('.lesson-topic').value.trim();
        const homework = item.querySelector('.lesson-homework').value.trim();
        const classwork = item.querySelector('.lesson-classwork').value.trim();

        const hiddenInput = item.querySelector('.lesson-data');
        const parts = hiddenInput.value.split(':');
        const id = parts[1] || "";
        hiddenInput.value = `${index + 1}:${id}:${topic}:${homework}:${classwork}`;

        lessons.push({ id, sequence: index + 1, topic, homework, classwork });
    });

}

function bindLessonInputListeners() {
    document.querySelectorAll('.draggable').forEach(item => {
        ['.lesson-topic', '.lesson-homework', '.lesson-classwork'].forEach(sel => {
            item.querySelector(sel)?.addEventListener('input', updateLessonInputs);
        });
    });
}

function bindDraggable(item) {
    item.addEventListener('dragstart', () => item.classList.add('dragging'));
    item.addEventListener('dragend', () => {
        item.classList.remove('dragging');
        updateLessonInputs();
    });

    item.addEventListener('touchstart', e => {
        startY = e.touches[0].clientY;
        longPressTimer = setTimeout(() => {
            touchDraggable = item;
            item.classList.add('dragging');
        }, 200);
    });

    item.addEventListener('touchend', () => {
        clearTimeout(longPressTimer);
        if (touchDraggable) {
            touchDraggable.classList.remove('dragging');
            touchDraggable = null;
        }
        updateLessonInputs();
    });

    item.addEventListener('touchmove', e => {
        if (!touchDraggable) {
            clearTimeout(longPressTimer);
            return;
        }
        const touch = e.touches[0];
        const container = [...dragContainers].find(c => c.contains(touchDraggable));
        const afterElement = getDragAfterElement(container, touch.clientY);
        if (afterElement == null) {
            container.appendChild(touchDraggable);
        } else {
            container.insertBefore(touchDraggable, afterElement);
        }
        e.preventDefault();
    });
}

function bindAllDraggables() {
    document.querySelectorAll('.draggable').forEach(bindDraggable);
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
}

// Drag Events
function bindDragContainers() {
    dragContainers.forEach(container => {
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(draggable);
            } else {
                container.insertBefore(draggable, afterElement);
            }
            updateLessonInputs();
        });
    });
}

// Initialize
bindLessonInputListeners();
bindAllDraggables();
bindDragContainers();

{% if not lessons %}

addLesson(); // Add initial lesson if none exist
{% endif %}

</script>

{% endblock dashboard %}